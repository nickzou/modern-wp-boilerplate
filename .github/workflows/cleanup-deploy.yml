name: Cleanup Preview Environment

on:
    pull_request:
        types: [closed] # Triggers when PR is closed (merged or just closed)
    delete:
        branches:
            - "**" # Triggers when any branch is deleted
            - "!dependabot/**"

jobs:
    check-infrastructure:
        runs-on: ubuntu-latest
        outputs:
            has-infra: ${{ steps.check.outputs.has-infra }}
        steps:
            - name: Check if infrastructure exists
              id: check
              run: |
                  if [ -n "${{ secrets.DROPLET_IP }}" ]; then
                    echo "has-infra=true" >> $GITHUB_OUTPUT
                  else
                    echo "has-infra=false" >> $GITHUB_OUTPUT
                  fi

    cleanup-preview:
        runs-on: ubuntu-latest
        needs: check-infrastructure
        if: needs.check-infrastructure.outputs.has-infra == 'true'
        steps:
            - name: Extract branch name
              id: branch
              run: |
                  if [ "${{ github.event_name }}" == "delete" ]; then
                    # For delete events
                    BRANCH="${{ github.event.ref }}"
                  else
                    # For PR closed events
                    BRANCH="${{ github.event.pull_request.head.ref }}"
                  fi
                  echo "BRANCH_NAME=${BRANCH}" >> $GITHUB_OUTPUT
                  echo "Cleaning up branch: ${BRANCH}"

            - name: Teardown preview environment
              uses: appleboy/ssh-action@v1.2.3
              with:
                  host: ${{ secrets.DROPLET_IP }}
                  username: root
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      /root/scripts/cleanup-preview.sh "${{ steps.branch.outputs.BRANCH_NAME }}"
